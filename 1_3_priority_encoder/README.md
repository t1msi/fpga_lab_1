
# priority_encoder

## task
Модуль должен во входном N-битном числе найти самую правую и самую левую единицу и оставить только ее.
На входе → Крайняя левая единица; Крайняя правая единица

## desc

| Параметр | Комментарий        | 
| -------- | ------------------ |
| WIDTH    | Разрядность данных |

| Имя сигнала  | Напр-е | Разрядность | Комментарий                                            |
| ------------ | ------ | ----------- |:------------------------------------------------------ |
| clk_i        | input  | 1           | Тактовый сигнал.                                       |
| srst_i       | input  | 1           | Синхронный сброс.                                      |
| data_i       | input  | WIDTH       | Входные данные.                                        |
| data_val_i   | input  | 1           | Сигнал валидности входных данных.                      |
| data_left_o  | output | WIDTH       | Выходная крайняя левая единица.                        |
| data_right_o | output | WIDTH       | Выходная крайняя правая единица.                       |
| data_val_o   | output | 1           | Подтверждает валидность data_right_o и<br>data_left_o. |

### alg
- 4 комбинационных блока, для :
    - присваивания во временную переменную data_i_copy значение data_i
    - вычисления data_left_o и data_right_o (с помощью вычисления max и min, соответственно)
    - выставление output валидности (в тот же такт, что и input)
- Остановка итераторов происходит, если бит data_i_copy положительный, начиная с противоположных концов (min и max).
- Передача во внешнюю среду происходит за 1 такт, после этого будут набираться новые значения

### test
В скрипте для ModelSim вызываются 2 собственные функции do_compile start_sim

В начале testbench происходит первичная инициализация, до момента когда rst_done станет равен 1.

Отправка проводится за счет генерации входной последовтельности в таске gen_data и передачи в data_i, целиком WIDTH бит. В цикле таска send_data меняется значение data_i и data_val_i, причем посылка идет целиком за 1 такт из-за валидности равной 1. Между вызовами send_data может проходить либо случайное количество циклов, либо без задержек (опция burst, по умолчанию. Для переключения передать в fifo_wr третий параметр 1)

После отправки целого числа, происходит запись в mailbox sended_data для сохранения, и последующего тестирования. Обработанные модулем данные в параллельном потоке читаются в mailbox read_data, запись происходит в момент, когда модуль дал сигнал о получении "посылки" с помощью бита валидности data_val_o. Сравнение происходит в compare_date, когда пройдет TEST_CNT + 4 итераций (добавляются corner cases).

При первого случаи несоответствия переданных и полученных данных, программа остановится.

### data

Комбинационно (за 1 такт):

| WIDTH | Slow 1100mV 85C Model Fmax Summary | Slow 1100mV 0C Model Fmax Summary |
| ----- | ---------------------------------- | --------------------------------- |
| 16    | 234.3                              | 229.67                            |
| 32    | 162.92                             | 161.32                            |
| 64    | 133.28                             | 135.72                            |
| 128   | 63.71                              | 66.33                             |
| 256   | -                                  | -                                 |
| 512   | -                                  | -                                 |
| 1024  | -                                  | -                                 | 

Последовательно (за WIDTH тактов):

| WIDTH | Slow 1100mV 85C Model Fmax Summary | Slow 1100mV 0C Model Fmax Summary |
| ----- | ---------------------------------- | --------------------------------- |
| 16    | 204.42                             | 203.25                            |
| 32    | 171.97                             | 179.44                            |
| 64    | 154.13                             | 156.72                            |
| 128   | 151.91                             | 152.53                            |
| 256   | 128.62                             | 127.68                            |
| 512   | 118.72                             | 117.79                            |
| 1024  | 102.28                             | 103.65                            | 

## install

```
git clone https://github.com/t1msi/fpga_lab_1.git
cd fpga_lab_1/1_3_priority_encoder/tb/
vsim&

do make.tcl
```

## ref
- https://www.youtube.com/playlist?list=PLOiK7Vmp7kf-YmjuuJKvDvmJdxKs826kx
- https://github.com/stcmtk/fpga-webinar-2020
- https://github.com/johan92/fpga-for-beginners
- https://habr.com/en/articles/281525/
- [Работа с битами](https://youtu.be/ZizuOhdl5oA?si=Yz_HniadGCZexxZX)
- https://stackoverflow.com/questions/29529730/priority-encoder-in-verilog