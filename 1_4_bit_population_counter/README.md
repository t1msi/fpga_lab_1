
# bit_population_counter

## task
Модуль должен в входном N-битном числе посчитать количество единиц. Latency (через сколько тактов будут могут доступны валидные выходные данные) на вашем
усмотрении. Чем меньше, тем лучше, но не менее 1 такта.

## desc

| Параметр | Комментарий        | 
| -------- | ------------------ |
| WIDTH    | Разрядность данных |

| Имя сигнала | Напр-е | Разрядность       | Комментарий                       | 
| ----------- | ------ | ----------------- |:--------------------------------- |
| clk_i       | input  | 1                 | Тактовый сигнал.                  |
| srst_i      | input  | 1                 | Синхронный сброс.                 |
| data_i      | input  | WIDTH             | Входные данные.                   |
| data_val_i  | input  | 1                 | Сигнал валидности входных данных. |
| data_o      | output | $clog2(WIDTH) + 1 | Выходные данные.                  |
| data_val_o  | output | 1                 | Сигнал валидности выходных данных |

### alg
#### COMB_BASIC
- 3 комбинационных блока, для :
    - присваивания во временную переменную data_i_copy значение data_i
    - вычисления data_o, перебирая каждый бит за O(N)
    - выставление output валидности (в тот же такт, что и input)
- Остановка итераторов происходит, когда i пройдет WIDTH бит
- Передача во внешнюю среду происходит за 1 такт, после этого будут набираться новые значения

#### COMB_HAM_WEIGHT
Параметры:
- IS_ODD - проверка WIDTH на четность
- PAIR_COUNT - количество пар
- PAIR_WIDTH - Размер памяти для пар

1 initial блок, для:
- инициализации LUT для перевода пары битов внутри data_i в popcount

- 2 комбинационный блок, для :
    - вычисления popcount по парам
    - выставление output валидности (в тот же такт, что и input)
- В каждой итерации происходит присваение пары бит, по возрастанию, из data_i, через LUT popcount2bits (для подсчета бит), запись идет в paircount, который состоит PAIR_WIDTH бит (ровно для каждой пары есть место). Для первой пары обработка идет отдельно
- После этого пара поочередно транслируется в соответствующее итератору место в popcount (Размер уже log(WIDTH), для хранения суммы с предыдущей парой)
- После прохождения всех пар, результат записывается в data_o. Но если WIDTH нечетный, то нужно добавить отдельно последний бит, у которого нет пары
- Передача во внешнюю среду происходит за 1 такт, после этого будут набираться новые значения

#### SEQ_LINEAR
- 3 последовательных блока, для контроля :
    - итератора mod_counter
    - бита валидности data_val_o
    - обработанных данных data_o (с помощью вычисления count)
- Остановка итератора происходит за счет следующих условий: либо срабатывание reset, либо равенство итератора с бит входных данных, либо data_i равен 0.
- Передача во внешнюю среду происходит за 1 такт, после этого будут набираться новые значения
- Запись идет за счет вычисления count, то есть перебирается каждый бит data_i за O(n)
- Управление происходит в конечном автомате сигналами IDLE_S, PROC_S. Сразу во время положительного data_val_o внешний модуль может подавать положительный data_val_i.


### test
В скрипте для ModelSim вызываются 2 собственные функции do_compile start_sim

В начале testbench происходит первичная инициализация, до момента когда rst_done станет равен 1.

Отправка проводится за счет генерации входной последовтельности в таске gen_data и передачи в data_i, целиком WIDTH бит. В цикле таска send_data меняется значение data_i и data_val_i, причем посылка идет целиком за 1 такт из-за валидности равной 1. Между вызовами send_data может проходить либо случайное количество циклов, либо без задержек (опция burst, по умолчанию. Для переключения передать в fifo_wr третий параметр 1)

После отправки целого числа, происходит запись в mailbox sended_data для сохранения, и последующего тестирования. Обработанные модулем данные в параллельном потоке читаются в mailbox read_data, запись происходит в момент, когда модуль дал сигнал о получении "посылки" с помощью бита валидности data_val_o. Сравнение происходит в compare_date, когда пройдет TEST_CNT + 4 итераций (добавляются corner cases).

При первого случаи несоответствия переданных и полученных данных, программа остановится.

### data
#### COMB_BASIC
| WIDTH | Slow 1100mV 85C | Slow 1100mV 0C | ALMs/Registers |
| ----- | --------------- | -------------- | -------------- |
| 16    | 162.07          | 154.75         | 27  , 23       |
| 32    | 130.57          | 124.6          | 51  , 40       |
| 64    | 90.1            | 85.1           | 91  , 73       |
| 128   | 73.99           | 69.62          | 178 , 138      |
| 256   | 65.02           | 60.98          | 336 , 267      |
| 512   | 60.43           | 57.24          | 671 , 524      |
| 1024  | 53.71           | 51.31          | 1310, 1037     |

#### COMB_HAM_WEIGHT
| WIDTH | Slow 1100mV 85C | Slow 1100mV 0C | ALMs/Registers |
| ----- | --------------- | -------------- | -------------- |
| 16    | 193.39          | 185.32         | 24  , 23       |
| 32    | 159.34          | 150.92         | 48  , 40       |
| 64    | 119.08          | 111.21         | 91  , 73       |
| 128   | 101.16          | 94.64          | 177 , 138      |
| 256   | 93.14           | 88.45          | 349 , 267      | 
| 512   | 80.21           | 75.73          | 693 , 524      |
| 1024  | 66.65           | 62.79          | 1382, 1037     |

#### SEQ_LINEAR
| WIDTH | Slow 1100mV 85C | Slow 1100mV 0C | ALMs/Registers |
| ----- | --------------- | -------------- | -------------- |
| 16    | 194.74          | 196.39         | 33  , 41       |
| 32    | 165.51          | 175.04         | 49  , 54       |
| 64    | 173.22          | 175.04         | 85  , 96       |
| 128   | 157.8           | 162.44         | 144 , 159      |
| 256   | 148.61          | 150.04         | 286 , 287      |
| 512   | 134.23          | 136.56         | 551 , 546      |
| 1024  | 114.38          | 113.87         | 1091, 1061     |

## install

```
git clone https://github.com/t1msi/fpga_lab_1.git
cd fpga_lab_1/1_4_bit_population_counter/tb/
vsim&

do make.tcl
```

## ref
- https://www.youtube.com/playlist?list=PLOiK7Vmp7kf-YmjuuJKvDvmJdxKs826kx
- https://github.com/stcmtk/fpga-webinar-2020
- https://github.com/johan92/fpga-for-beginners
- https://habr.com/en/articles/281525/
- [Работа с битами](https://youtu.be/ZizuOhdl5oA?si=Yz_HniadGCZexxZX)