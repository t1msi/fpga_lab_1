
# priority_encoder

## task
Требуется написать модуль для управления светофором, который будет зажигать красный, желтый и зеленый фонари во всем известной последовательности:
1. Красный;
2. Красный и желтый;
3. Зеленый;
4. Зеленый моргает;
5. Желтый;
6. Красный.

Модуль может быть включен или выключен. При включении или сброса переходит в режим “Красный”. Модуль может быть переведен в режим “неуправляемый переход” (это когда просто моргает желтый) и обратно. Время нахождения в состояниях красный, зеленый, желтый может быть настроено динамически в мс. Для всех настроек используйте шину cmd_i, где будут закодированы все необходимые команды. У светофора длительности настраиваются только в режиме неуправляемого перехода.

## desc

| Параметр              | Комментарий                                                          |
| --------------------- | -------------------------------------------------------------------- |
| BLINK_HALF_PERIOD_MS  | Полупериод “моргания” желтого и зеленого одинаковый в миллисекундах. |
| BLINK_GREEN_TIME_TICK | Время нахождения “зеленый мигает” в кол-ве периодов моргания.        |
| RED_YELLOW_MS         | Время нахождения в состоянии “красный+желтый” в миллисекундах.       | 

| Имя сигнала | Напр-е | Разрядность | Комментарий                                                                                           |
| ----------- | ------ | ----------- |:----------------------------------------------------------------------------------------------------- |
| clk_i       | input  | 1           | Тактовый сигнал 2 КГц.                                                                                |
| srst_i      | input  | 1           | Синхронный сброс.                                                                                     |
| cmd_type_i  | input  | 3           | Код команды для управления устройством (см коды ниже).                                                |
| cmd_valid_i | input  | 1           | Сигнал валидности команды.                                                                            |
| cmd_data_i  | input  | WIDTH = 16  | Просто данные, сопровождающие команду. Могут использоваться для установки пресета одного из значений. |
| red_o       | output | 1           | Горит красный.                                                                                        |
| yellow_o    | output | 1           | Горит желтый.                                                                                         |
| green_o     | output | 1           | Горит зеленый.                                                                                        | 

| cmd_type_i | Назначение                                 |
| ---------- | ------------------------------------------ |
| 0          | Включить/перевести в стандартный режим.    |
| 1          | Выключить.                                 |
| 2          | Перевести в режим “неуправляемый переход”. |
| 3          | Установить время горения зеленого.         |
| 4          | Установить время горения красного.         |
| 5          | Установить время горения желтого.          | 

### alg
- 3 Конечных автомата, для контроля:
  - Переключения состояний mode, то есть Выключенный - SHUTDOWN_M, Обычный - NORMAL_M, "Неуправляемый переход" - NOTRANSITION_M. Зависит от входа комманд в cmd_type_i.
  - Переключения состояний state, то есть Красный - RED_S, Красный и Желтый - RED_YELLOW_S, Зеленый - GREEN_S, Зеленый мигающий - GREEN_BLINK_S, Желтый - YELLOW_S, Желтый мигающий - YELLOW_S. Зависит от предыдущих состояний и входных комманд
  - Переключения выходных сигналов red_o, yellow_o, green_o. Зависит от next_mode и next_state (non-blocking assignment реализация)
  
- 5 последовательных блоков, для контроля :
    - счетчика counter_tick, для количества миганий в GREEN_BLINK_S и YELLOW_BLINK_S (сами сигналы)
    - счетчика half_for_tick, для количества миганий в GREEN_BLINK_S и YELLOW_BLINK_S (половины между горящими сигналами)
    - счетчика counter_half_period, для количества миганий в GREEN_BLINK_S и YELLOW_BLINK_S (половины внутри горящего сигнала)
    - счетчика counter_red_yellow, для количества RED_YELLOW_MS
    - счетчика counter_width, для количества времени зеленого, желтого и красного (динамические параметры хранятся в time_entity)

### test
В скрипте для ModelSim вызываются 2 собственные функции do_compile start_sim

В начале testbench происходит первичная инициализация, до момента когда rst_done станет равен 1.

Отправка проводится за счет генерации входной последовтельности в таске gen_data и передачи в cmd_type_i, cmd_valid_i, cmd_data_i. В цикле таска send_data последовательно подаются команды (в зависимости от тест кейса NORMAL_T и NOTRANSITION_T), причем посылка идет целиком за 1 такт из-за валидности cmd_valid_i равной 1. Между вызовами send_data может проходить либо случайное количество циклов, либо без задержек (опция burst, по умолчанию. Для переключения изменять параметр BURST_MODE).

После отправки и перед ней целого числа, происходит запись в mailbox sended_data и глобальную переменную test_data, соответственно, для сохранения, и последующего тестирования. Данные из модуля в параллельном потоке читаются в mailbox read_data. Действие происходит в таске check_data, где проверяются задержки и количество миганий, в будущем верификация происходит по контройльной сумме checksum_data (будет сравнение генерированной и полученной).

Начало всех тестов происходит в момент, когда передалась команда NOTRANSITION_CMD, а конец при передачи SHUTDOWN_CMD. Сначала выполняется большой тест со случайными значениями в TEST_CNT количестве (NORMAL_T), потом один тест на проверку NOTRANSITION_M (NOTRANSITION_T).

Сравнение происходит в compare_date, когда пройдет TEST_CNT + 1 итераций (добавляются corner cases).

При первого случаи несоответствия переданных и полученных данных, программа остановится. (можно изменять есть включить DEBUG)

### data
| WIDTH | Slow 1100mV 85C | Slow 1100mV 0C | ALMs/Registers |
| ----- | --------------- | -------------- | -------------- |
| 16    | 112.45          | 109.13         | 128, 122       |

## install

```
git clone https://github.com/t1msi/fpga_lab_1.git
cd fpga_lab_1/1_6_priority_encoder/tb/
vsim&

do make.tcl
```

## ref
- https://www.youtube.com/playlist?list=PLOiK7Vmp7kf-YmjuuJKvDvmJdxKs826kx
- https://github.com/stcmtk/fpga-webinar-2020
- [Конечные автоматы](https://www.youtube.com/watch?v=KlV1srH5erQ&t=1124s)